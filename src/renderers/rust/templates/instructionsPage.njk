{% extends "layout.njk" %}
{% import "macros.njk" as macros %}

{% block main %}

{{ imports }}

/// Accounts.
pub struct {{ instruction.name | pascalCase }} {
{% for account in instruction.accounts %}
  {% if account.docs.length > 0 %}
    {{ macros.docblock(account.docs) }}
  {% endif %}

  {% if account.isSigner === 'either' %}
    {% set type = '(solana_program::pubkey::Pubkey, bool)' %}
  {% else %}
    {% set type = 'solana_program::pubkey::Pubkey' %}
  {% endif %}

  {% if account.isOptional %}
    pub {{ account.name | snakeCase }}: Option<{{ type }}>,
  {% else %}
    pub {{ account.name | snakeCase }}: {{ type }},
  {% endif %}
{% endfor %}
}

impl {{ instruction.name | pascalCase }} {
  pub fn instruction(&self{{ ', args: ' + instruction.name | pascalCase + 'InstructionArgs' if hasArgs }}) -> solana_program::instruction::Instruction {
    {% if hasArgs === false %}
    let args = {{ instruction.name | pascalCase }}InstructionArgs::new();
    {% endif %}
    solana_program::instruction::Instruction {
      program_id: crate::{{ program.name | snakeCase | upper }}_ID,
      accounts: vec![
        {% for account in instruction.accounts %}
          {% if account.isSigner === 'either' %}
            {% if account.isOptional %}
              if let Some(({{ account.name | snakeCase }}, signer)) = self.{{ account.name | snakeCase }} {
                solana_program::instruction::AccountMeta::{{ 'new' if account.isWritable else 'new_readonly' }}(
                  {{ account.name | snakeCase }},
                  signer,
                )
              } else {
                solana_program::instruction::AccountMeta::new_readonly(
                  crate::{{ program.name | snakeCase | upper }}_ID,
                  false,
                )
              },
            {% else %}
              solana_program::instruction::AccountMeta::{{ 'new' if account.isWritable else 'new_readonly' }}(
                self.{{ account.name | snakeCase }}.0,
                self.{{ account.name | snakeCase }}.1,
              ),
            {% endif %}
          {% else %}
            {% if account.isOptional %}
              if let Some({{ account.name | snakeCase }}) = self.{{ account.name | snakeCase }} {
                solana_program::instruction::AccountMeta::{{ 'new' if account.isWritable else 'new_readonly' }}(
                  {{ account.name | snakeCase }},
                  {{ 'true' if account.isSigner else 'false' }},
                )
              } else {
                solana_program::instruction::AccountMeta::new_readonly(
                  crate::{{ program.name | snakeCase | upper }}_ID,
                  false,
                )
              },
            {% else %}
              solana_program::instruction::AccountMeta::{{ 'new' if account.isWritable else 'new_readonly' }}(
                self.{{ account.name | snakeCase }},
                {{ 'true' if account.isSigner else 'false' }}
              ),
            {% endif %}
          {% endif %}
        {% endfor %}
      ],
      data: args.try_to_vec().unwrap(),
    }
  }
}

#[derive(BorshSerialize, BorshDeserialize, Debug)]
{{ 'pub ' if hasArgs }}struct {{ instruction.name | pascalCase }}InstructionArgs {
  {% for arg in instructionArgs %}
    {{ 'pub ' if not arg.default }}{{ arg.name | snakeCase }}: {{ arg.type }},
  {% endfor %}
}

{% for nestedStruct in typeManifest.nestedStructs %}
{{ nestedStruct }}
{% endfor %}

impl {{ instruction.name | pascalCase }}InstructionArgs {
  pub fn new(
    {% for arg in instructionArgs %}
      {% if not arg.default and not arg.optional %}
        {{ arg.name | snakeCase }}: {{ arg.type }},
      {% endif %}
    {% endfor %}
  ) -> Self {
    Self {
      {% for arg in instructionArgs %}
        {% if arg.default or arg.optional %}
          {{ arg.name | snakeCase }}: {{ arg.value }},
        {% else %}
          {{ arg.name | snakeCase }},
        {% endif %}
      {% endfor %}
    }
  }
}

{% include "instructionsPageBuilder.njk" %}

{% include "instructionsCpiPage.njk" %}

{% endblock %}
