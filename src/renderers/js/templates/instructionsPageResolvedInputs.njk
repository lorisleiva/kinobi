{% set hasResolvedAccounts = accounts.length > 0 or hasResolvers %}
{% set hasResolvedArgs = hasDataArgs or hasArgDefaults or hasResolvers %}
{% macro getAccountVar(name, accountsObj) -%}
  {{ 'resolvingAccounts' if accountsWithDefaults.includes(name) else accountsObj }}.{{ name | camelCase }}
{%- endmacro %}
{% macro getArgVar(name, argsObj) -%}
  {{ 'resolvingArgs' if argsWithDefaults.includes(name) else argsObj }}.{{ name | camelCase }}
{%- endmacro %}

{% if resolvedInputs.length > 0 or hasResolvedAccounts or hasResolvedArgs %}
  // Resolved inputs.
  {% if hasResolvedAccounts %}
    const resolvingAccounts = {};
  {% endif %}
  {% if hasResolvedArgs %}
    const resolvingArgs = {};
  {% endif %}
  {% for input in resolvedInputsWithDefaults %}
    {% if input.kind === 'account' %}
      {% set accountPrefix %}resolvingAccounts, '{{ input.name | camelCase }}', {{ accountsObj }}.{{ input.name | camelCase }} ??{% endset %}
      {% if input.defaultsTo.kind === 'account' %}
        addObjectProperty({{ accountPrefix }} {{ getAccountVar(input.defaultsTo.name, accountsObj) }});
      {% elif input.defaultsTo.kind === 'pda' %}
        addObjectProperty({{ accountPrefix }} find{{ input.defaultsTo.pdaAccount | pascalCase }}Pda(context,
        {%- if (input.defaultsTo.seeds | length) > 0 -%}
          {
            {%- for seedKey, seedValue in input.defaultsTo.seeds -%}
              {%- if seedValue.kind === 'value' -%}
                {{ seedKey }}: {{ seedValue.render }},
              {%- elif seedValue.kind === 'account' -%}
                {{ seedKey }}: publicKey({{ getAccountVar(seedValue.name, accountsObj) }}),
              {%- else -%}
                {{ seedKey }}: {{ getArgVar(seedValue.name, argsObj) }},
              {%- endif -%}
            {%- endfor -%}
          }
        {%- endif -%}
        ));
      {% elif input.defaultsTo.kind === 'publicKey' %}
        addObjectProperty({{ accountPrefix }} publicKey('{{ input.defaultsTo.publicKey }}'));
      {% elif input.defaultsTo.kind === 'program' %}
        addObjectProperty({{ accountPrefix }} { ...context.programs.getPublicKey('{{ input.defaultsTo.program.name }}', '{{ input.defaultsTo.program.publicKey }}'), isWritable: false });
      {% elif input.defaultsTo.kind === 'programId' %}
        addObjectProperty({{ accountPrefix }} programId);
      {% elif input.defaultsTo.kind === 'identity' and (input.isSigner !== false) %}
        addObjectProperty({{ accountPrefix }} context.identity);
      {% elif input.defaultsTo.kind === 'identity' %}
        addObjectProperty({{ accountPrefix }} context.identity.publicKey);
      {% elif input.defaultsTo.kind === 'payer' and (input.isSigner !== false) %}
        addObjectProperty({{ accountPrefix }} context.payer);
      {% elif input.defaultsTo.kind === 'payer' %}
        addObjectProperty({{ accountPrefix }} context.payer.publicKey);
      {% elif input.defaultsTo.kind === 'resolver' %}
        addObjectProperty({{ accountPrefix }} {{ input.defaultsTo.name | camelCase }}(context, { ...{{ accountsObj }}, ...resolvingAccounts }, { ...{{ argsObj }}, ...resolvingArgs }, programId));
      {% endif %}
    {% elif input.kind === 'arg' %}
      {% set argPrefix %}resolvingArgs, '{{ input.name | camelCase }}', {{ argsObj }}.{{ input.name | camelCase }} ??{% endset %}
      {% if input.defaultsTo.kind === 'arg' %}
        addObjectProperty({{ argPrefix }} {{ getArgVar(input.defaultsTo.name, argsObj) }});
      {% elif input.defaultsTo.kind === 'account' %}
        addObjectProperty({{ argPrefix }} {{ getAccountVar(input.defaultsTo.name, accountsObj) }});
      {% elif input.defaultsTo.kind === 'accountBump' %}
        addObjectProperty({{ argPrefix }} {{ getAccountVar(input.defaultsTo.name, accountsObj) }}.bump);
      {% elif input.defaultsTo.kind === 'value' %}
        addObjectProperty({{ argPrefix }} {{ input.defaultsTo.render }});
      {% elif input.defaultsTo.kind === 'resolver' %}
        addObjectProperty({{ argPrefix }} {{ input.defaultsTo.name | camelCase }}(context, { ...{{ accountsObj }}, ...resolvingAccounts }, { ...{{ argsObj }}, ...resolvingArgs }, programId));
      {% endif %}
    {% endif %}
  {% endfor %}
  {% if hasResolvedAccounts %}
    const resolvedAccounts = { ...{{ accountsObj }}, ...resolvingAccounts };
  {% endif %}
  {% if hasResolvedArgs %}
    const resolvedArgs = { ...{{ argsObj }}, ...resolvingArgs };
  {% endif %}
{% endif %}
